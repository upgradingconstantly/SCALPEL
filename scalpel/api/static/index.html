<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCALPEL - Computational CRISPR Design Platform</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>

<body>
    <header>
        <div class="header-left">
            <div id="header-canvas"></div>
            <div>
                <div class="logo">SCALPEL</div>
                <div class="tagline">Computational CRISPR Design Platform</div>
            </div>
        </div>
        <div class="header-controls">
            <button class="settings-btn icon-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" />
                    <path
                        d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
                </svg>
            </button>
        </div>
    </header>

    <div class="main-grid">
        <aside>
            <div class="panel-title">Design Parameters</div>
            <div class="form-group">
                <label>Gene Symbol</label>
                <input type="text" id="gene" placeholder="e.g., TP53, BRCA1" autocomplete="off">
                <div id="recentDropdown" class="recent-dropdown"></div>
            </div>
            <div class="form-group">
                <label>Modality</label>
                <select id="modality">
                    <option value="knockout">Knockout (NHEJ)</option>
                    <option value="interference">CRISPRi</option>
                    <option value="activation">CRISPRa</option>
                    <option value="base_edit_cbe">Base Edit (CBE)</option>
                    <option value="base_edit_abe">Base Edit (ABE)</option>
                    <option value="prime_edit">Prime Edit</option>
                </select>
            </div>
            <div class="form-group">
                <label>Genome</label>
                <select id="genome">
                    <option value="GRCh38">Human (GRCh38)</option>
                    <option value="GRCh37">Human (GRCh37)</option>
                    <option value="GRCm39">Mouse (GRCm39)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cas Variant</label>
                <select id="cas_variant">
                    <option value="SpCas9">SpCas9 (NGG)</option>
                    <option value="SpCas9-NG">SpCas9-NG</option>
                    <option value="SaCas9">SaCas9</option>
                    <option value="Cas12a">Cas12a</option>
                </select>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" id="designBtn" onclick="designGuides()">Design</button>
            </div>

            <!-- Shortcuts moved to bottom -->
            <div class="shortcuts-section">
                <div class="panel-title">Shortcuts</div>
                <div class="shortcuts-list">
                    <div><kbd>Enter</kbd> Design</div>
                    <div><kbd>←</kbd> <kbd>→</kbd> Pages</div>
                    <div><kbd>Esc</kbd> Close</div>
                    <div><kbd>Ctrl+C</kbd> Copy</div>
                </div>
            </div>
        </aside>

        <main>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('guides')">Guides</button>
                <button class="tab" onclick="switchTab('offtarget')">Off-Targets</button>
                <button class="tab" onclick="switchTab('plan')">Experiment Plan</button>
                <button class="tab" onclick="switchTab('visualization')">Visualization</button>
            </div>

            <div id="status" class="status-indicator success" style="display:none;"></div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width:0%"></div>
                </div>
                <p id="progressText" class="progress-text">Finding candidates...</p>
            </div>

            <div id="summary" class="summary-stats" style="display:none;">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Candidates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-efficiency">0%</div>
                    <div class="stat-label">Avg Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-gene">-</div>
                    <div class="stat-label">Target</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-modality">-</div>
                    <div class="stat-label">Modality</div>
                </div>
            </div>

            <!-- Stacked Visualizations -->
            <div id="visualizations" class="viz-stack" style="display:none;">
                <div class="viz-panel large">
                    <div class="viz-header">
                        <div class="viz-title">Efficiency Distribution</div>
                        <button class="expand-btn" onclick="expandEfficiency()" title="Expand">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                            </svg>
                        </button>
                    </div>
                    <div id="efficiency-chart"></div>
                </div>
                <div class="viz-panel large">
                    <div class="viz-header">
                        <div class="viz-title">Genomic Position Map</div>
                        <button class="expand-btn" onclick="expandGenomeMap()" title="Expand">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                            </svg>
                        </button>
                    </div>
                    <div id="genome-map"></div>
                </div>
            </div>

            <div id="sequence-viz" class="viz-panel sequence-panel" style="display:none;margin-bottom:1rem;">
                <div class="viz-header">
                    <div class="viz-title">Target Sequence</div>
                    <button class="expand-btn" onclick="expandSequence()" title="Expand">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" />
                        </svg>
                    </button>
                </div>
                <div id="sequence-canvas"></div>
            </div>

            <div id="results-guides">
                <div class="results-controls">
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="Search sequence..." onkeyup="applySearch()">
                        <select onchange="applyStrandFilter(this.value)">
                            <option value="all">All Strands</option>
                            <option value="+">+ Strand</option>
                            <option value="-">- Strand</option>
                        </select>
                        <button class="btn btn-secondary" id="bulkCopyBtn" onclick="bulkCopySelected()"
                            style="display:none;">Copy Selected</button>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-secondary" id="compareBtn" onclick="openCompare()" disabled>Compare
                            (0)</button>
                        <button class="btn btn-secondary" onclick="openExportDialog()">Export</button>
                        <select class="per-page-select" onchange="setPerPage(this.value)">
                            <option value="50">50/page</option>
                            <option value="100">100/page</option>
                            <option value="500">500/page</option>
                        </select>
                        <label class="infinite-scroll-toggle">
                            <input type="checkbox" id="infiniteScrollToggle" onchange="toggleInfiniteScroll()">
                            Infinite
                        </label>
                        <button class="btn btn-secondary" id="prevBtn" onclick="prevPage()">&larr;</button>
                        <span id="pageInfo">Page 1</span>
                        <button class="btn btn-secondary" id="nextBtn" onclick="nextPage()">&rarr;</button>
                    </div>
                </div>
                <div id="guides-container" class="results-area">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>Enter a gene symbol and click "Design"</p>
                    </div>
                </div>
            </div>

            <div id="results-offtarget" style="display:none;"></div>
            <div id="results-plan" style="display:none;"></div>
            <div id="results-visualization" style="display:none;">
                <div class="viz-panel" style="min-height:500px;">
                    <div class="viz-header">
                        <div class="viz-title">3D DNA Double Helix</div>
                        <div class="viz-controls">
                            <label>Speed: <input type="range" id="helixSpeed" min="0" max="100" value="30"
                                    onchange="updateHelixSpeed(this.value)"></label>
                            <button class="btn btn-secondary" onclick="resetHelixView()">Reset View</button>
                        </div>
                    </div>
                    <div id="dna-helix-viz" style="width:100%;height:420px;"></div>
                    <div class="dna-legend">
                        <div class="legend-item"><span class="legend-dot" style="background:#22c55e;"></span><span
                                class="legend-label">A - Adenine</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:#ef4444;"></span><span
                                class="legend-label">T - Thymine</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:#eab308;"></span><span
                                class="legend-label">G - Guanine</span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:#3b82f6;"></span><span
                                class="legend-label">C - Cytosine</span></div>
                    </div>
                    <p style="text-align:center;color:#64748b;font-size:0.8rem;margin-top:0.75rem;">Drag to rotate •
                        Scroll to zoom • Click nucleotide for info</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal" style="width:400px;">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>DNA Color Scheme</h4>
                    <div class="color-presets">
                        <button class="color-preset active" data-preset="default"
                            onclick="setColorPreset('default')">Default</button>
                        <button class="color-preset" data-preset="ucsc" onclick="setColorPreset('ucsc')">UCSC</button>
                        <button class="color-preset" data-preset="colorblind"
                            onclick="setColorPreset('colorblind')">Colorblind</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Efficiency Fullscreen Modal -->
    <div id="efficiencyModal" class="modal-overlay fullscreen-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Efficiency Distribution</div>
                <button class="modal-close" onclick="closeEfficiencyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="efficiency-chart-fullscreen" style="width:100%;height:100%;"></div>
            </div>
        </div>
    </div>

    <!-- Genome Map Fullscreen Modal -->
    <div id="genomeModal" class="modal-overlay fullscreen-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Genomic Position Map</div>
                <button class="modal-close" onclick="closeGenomeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="genome-map-fullscreen" style="width:100%;height:100%;"></div>
            </div>
        </div>
    </div>

    <!-- Sequence Fullscreen Modal -->
    <div id="sequenceModal" class="modal-overlay fullscreen-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Target Sequence</div>
                <button class="modal-close" onclick="closeSequenceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="sequence-canvas-fullscreen" style="width:100%;height:100%;"></div>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div id="compareModal" class="modal-overlay">
        <div class="modal" style="width:800px;max-height:85vh;">
            <div class="modal-header">
                <div class="modal-title">Compare Guides</div>
                <button class="modal-close" onclick="closeCompareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="compare-section">
                    <h4>Sequence Alignment</h4>
                    <div id="compareAlignment" class="compare-alignment"></div>
                </div>
                <div class="compare-section">
                    <h4>Efficiency Comparison</h4>
                    <div id="compareTable"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal-overlay">
        <div class="modal" style="width:480px;">
            <div class="modal-header">
                <div class="modal-title">Export Guides</div>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-row">
                        <label>Candidates:</label>
                        <div class="preset-btns">
                            <button class="preset-btn" onclick="setExportCount(10)">10</button>
                            <button class="preset-btn" onclick="setExportCount(20)">20</button>
                            <button class="preset-btn" onclick="setExportCount(50)">50</button>
                            <button class="preset-btn active" onclick="setExportCount(100)">100</button>
                            <button class="preset-btn" onclick="setExportCount(500)">500</button>
                            <button class="preset-btn" onclick="setExportCount('all')">All</button>
                        </div>
                    </div>
                    <div class="export-row">
                        <label>Custom count:</label>
                        <input type="number" id="exportCount" value="100" min="1" style="width:100px;">
                    </div>
                    <div class="export-row">
                        <label>Min efficiency:</label>
                        <input type="number" id="exportMinEff" value="0" min="0" max="100" style="width:80px;"> %
                    </div>
                    <div class="btn-row" style="margin-top:1.5rem;">
                        <button class="btn btn-secondary" onclick="exportCSV()">CSV</button>
                        <button class="btn btn-primary" onclick="exportPDF()">PDF Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>

</html>